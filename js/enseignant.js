// ── i18n: French translations (default) ─────────────────────────────────────
var translations_fr = {
    // Page
    teacher_page_title: "Canevas Persona : Personnel d\u2019\u00e9ducation",
    teacher_heading: "Canevas de Persona pour le personnel d\u2019\u00e9ducation",
    teacher_subtitle: "Prototype pour aider \u00e0 concevoir des formations adapt\u00e9es \u00e0 la r\u00e9alit\u00e9 terrain.",

    // Action groups
    teacher_grp_options: "Options",
    teacher_grp_display: "Affichage",
    teacher_grp_management: "Gestion",
    teacher_grp_io: "IMPORT & EXPORT",
    teacher_grp_improve: "AM\u00c9LIORATIONS",
    teacher_grp_help: "Aide",
    teacher_grp_language: "Langue",

    // Toggle labels
    teacher_lbl_basic: "Basique",
    teacher_lbl_advanced: "Avanc\u00e9",
    teacher_lbl_suggestions: "Suggestions",

    // Tooltips
    teacher_tip_reset: "R\u00e9initialiser le canevas",
    teacher_tip_load: "Charger une sauvegarde (JSON)",
    teacher_tip_save: "Sauvegarder (JSON)",
    teacher_tip_pdf: "Exporter en PDF",
    teacher_tip_md: "Exporter Profil (Markdown)",
    teacher_tip_full_md: "Exporter Canevas Complet (Markdown)",
    teacher_tip_suggest: "Proposer une am\u00e9lioration (export local)",
    teacher_tip_guide: "Guide d\u2019utilisation",
    teacher_tip_about: "\u00c0 propos",
    teacher_tip_load_lang: "Charger un pack de langue",
    teacher_tip_clear_suggestions: "Supprimer toutes les suggestions locales",

    // Card 1: Identité
    teacher_card_identity: "Identit\u00e9",
    teacher_desc_identity: "Profil administratif et personnel.",
    teacher_lbl_firstname: "Pr\u00e9nom",
    teacher_ph_firstname: "Ex: Julie",
    teacher_lbl_education_sector: "Secteur d\u2019\u00e9ducation",
    teacher_opt_select: "S\u00e9lectionner...",
    teacher_optgrp_preprimary: "Enseignement pr\u00e9scolaire et primaire",
    teacher_opt_preschool: "Pr\u00e9scolaire / Maternelle",
    teacher_opt_primary: "Primaire / \u00c9l\u00e9mentaire",
    teacher_optgrp_secondary: "Enseignement secondaire",
    teacher_opt_middle: "Secondaire (premier cycle / inférieur)",
    teacher_opt_high_general: "Secondaire (deuxième cycle / supérieur) — général",
    teacher_opt_high_vocational: "Secondaire — technique et professionnel",
    teacher_optgrp_higher: "Enseignement sup\u00e9rieur",
    teacher_opt_university: "Universit\u00e9",
    teacher_opt_grande_ecole: "Haute école / École spécialisée",
    teacher_opt_technical: "Collège / CÉGEP / Institut technologique",
    teacher_optgrp_continuing: "Formation continue",
    teacher_opt_adult_training: "Formation d\u2019adultes / Continue",
    teacher_opt_vocational_training: "Formation professionnelle / Apprentissage",
    teacher_optgrp_other: "Autre",
    teacher_opt_specialized: "Éducation spécialisée / adaptation scolaire",
    teacher_opt_other: "Autre contexte \u00e9ducatif",
    teacher_lbl_discipline: "Discipline / Sp\u00e9cialit\u00e9",
    teacher_ph_discipline: "Ex: Math\u00e9matiques, Histoire-G\u00e9o, Informatique...",
    teacher_lbl_status: "Statut",
    teacher_opt_tenured: "Permanent",
    teacher_opt_contract: "Contractuel·le",
    teacher_opt_trainee: "En formation initiale (stage / insertion)",
    teacher_lbl_experience: "Ann\u00e9es d\u2019exp\u00e9rience",
    teacher_ph_experience: "Ex: 5 ans, D\u00e9butant...",

    // Advanced options
    teacher_advanced_label: "Options avanc\u00e9es",
    teacher_lbl_career_path: "Parcours professionnel",
    teacher_opt_local_hire: "Recrutement local",
    teacher_opt_transfer: "Mutation / Affectation",
    teacher_opt_career_change: "Reconversion professionnelle",
    teacher_lbl_institution_tenure: "Anciennet\u00e9 dans l\u2019\u00e9tablissement",
    teacher_opt_newcomer: "Nouvel arrivant (< 1 an)",
    teacher_opt_recent: "1 \u00e0 3 ans",
    teacher_opt_established: "Plus de 3 ans",

    // Card 2: Localisation & classe
    teacher_card_context: "Localisation & classe",
    teacher_desc_context: "Environnement et conditions d\u2019exercice.",
    teacher_lbl_details: "D\u00e9tails",
    teacher_ph_details: "D\u00e9tails",
    teacher_lbl_school_type: "Type d\u2019\u00e9tablissement",
    teacher_ph_school_type: "Ex: \u00c9cole de quartier...",
    teacher_lbl_class_profile: "Profil g\u00e9n\u00e9ral de la classe",
    teacher_chk_heterogeneity: "H\u00e9t\u00e9rog\u00e9n\u00e9it\u00e9 scolaire",
    teacher_chk_climate: "Gestion de classe difficile",
    teacher_chk_multilevel: "Classe \u00e0 double ou triple niveau",
    teacher_chk_overcrowded: "Classe surcharg\u00e9e / Faible effectif",
    teacher_chk_inclusion: "\u00c9l\u00e8ves \u00e0 besoins particuliers (ULIS, EBEP)",
    teacher_chk_social: "Pr\u00e9carit\u00e9 sociale des familles",
    teacher_chk_turnover_students: "Fort turnover des \u00e9l\u00e8ves",
    teacher_lbl_geographic_context: "Contexte g\u00e9ographique",
    teacher_chk_rural: "Zone rurale / Isolement g\u00e9ographique",
    teacher_chk_priority_zone: "Zone d\u2019\u00e9ducation prioritaire (REP/REP+)",
    teacher_chk_remote_access: "Acc\u00e8s difficile (montagne, \u00eele, etc.)",
    teacher_chk_overseas: "Territoire ultramarin",
    teacher_lbl_linguistic_context: "Contexte linguistique",
    teacher_chk_multilingual: "Classes plurilingues",
    teacher_chk_allophone: "\u00c9l\u00e8ves allophones nouvellement arriv\u00e9s (EANA)",
    teacher_chk_regional_lang: "Enseignement de langue r\u00e9gionale",

    // Card 3: Numérique
    teacher_card_digital: "Num\u00e9rique",
    teacher_desc_digital: "\u00c9quipement et comp\u00e9tences technologiques.",
    teacher_lbl_tools_usage: "Outils & Usages",
    teacher_chk_office: "Bureautique (Word/PPT)",
    teacher_chk_institution: "Outils institutionnels (portail, ENA/LMS)",
    teacher_chk_smartphone: "Smartphone uniquement",
    teacher_chk_no_computer: "Pas d\u2019ordi perso / Partage \u00e9quipement",
    teacher_chk_basic_training: "Besoin formation bases (fichiers, mails)",
    teacher_chk_paper_only: "Privil\u00e9gie le papier / R\u00e9ticent num\u00e9rique",
    teacher_chk_social_watch: "Veille via r\u00e9seaux sociaux (Insta/TikTok)",
    teacher_chk_ai_curious: "Curieux/Utilisateur IA g\u00e9n\u00e9rative",
    teacher_chk_cloud_academic: "Utilise le cloud acad\u00e9mique (Nuage/Apps)",
    teacher_lbl_equipment_challenges: "D\u00e9fis mat\u00e9riels sp\u00e9cifiques",
    teacher_chk_shared_devices: "\u00c9quipements partag\u00e9s entre coll\u00e8gues",
    teacher_chk_byod: "Utilisation d\u2019\u00e9quipement personnel obligatoire (BYOD)",
    teacher_chk_outdated: "Mat\u00e9riel obsol\u00e8te ou en panne",

    // Card 4: Motivations
    teacher_card_motivations: "Motivations",
    teacher_desc_motivations: "Besoins et attentes vis-\u00e0-vis de la formation.",
    teacher_lbl_why_train: "Pourquoi se former ?",
    teacher_chk_class_mgmt: "Gestion de classe / Autorit\u00e9",
    teacher_chk_exam_prep: "Pr\u00e9paration aux concours",
    teacher_chk_time_saving: "Gain de temps (Ressources pr\u00eates)",
    teacher_chk_innovation: "Tester de nouvelles approches (Ludification, etc.)",
    teacher_chk_wellbeing: "Climat de classe / Bien-\u00eatre",
    teacher_chk_career: "\u00c9volution de carri\u00e8re/perspectives",
    teacher_chk_project: "Monter un projet (Sortie, \u00e9change)",
    teacher_lbl_infrastructure: "Contraintes d\u2019infrastructure",
    teacher_chk_power: "Coupures \u00e9lectriques fr\u00e9quentes",
    teacher_chk_building: "Locaux v\u00e9tustes ou inadapt\u00e9s",
    teacher_chk_climate_extreme: "Climat extr\u00eame (chaleur, froid, etc.)",
    teacher_chk_seasonal_access: "Acc\u00e8s saisonnier difficile",

    // Card 5: Freins
    teacher_card_obstacles: "Freins",
    teacher_desc_obstacles: "Obstacles potentiels \u00e0 l\u2019apprentissage.",
    teacher_lbl_obstacles: "Obstacles \u00e0 la formation",
    teacher_chk_workload: "Charge de travail",
    teacher_chk_training_gap: "Offre de formation inadapt\u00e9e",
    teacher_chk_logistics: "Transport / Logistique (Acc\u00e8s formation)",
    teacher_chk_language_barrier: "Barri\u00e8re de la langue (Enseignant/\u00c9l\u00e8ves)",
    teacher_chk_unstable_internet: "Connexion domicile instable/inexistante",
    teacher_chk_low_motivation: "Faible motivation",
    teacher_chk_jetlag: "D\u00e9calage horaire (si formateur distant)",

    // Card 6: Format
    teacher_card_format: "Format",
    teacher_desc_format: "Modalit\u00e9s p\u00e9dagogiques pr\u00e9f\u00e9r\u00e9es.",
    teacher_lbl_preferred_formats: "Formats pr\u00e9f\u00e9r\u00e9s",
    teacher_chk_micro: "Micro-learning (5-10 min)",
    teacher_chk_mobile: "Mobile Learning",
    teacher_chk_visio: "Visio-conf\u00e9rence (Synchrones)",
    teacher_chk_hybrid: "Hybride (Pr\u00e9sentiel + Distanciel)",
    teacher_chk_tutoring: "Tutorat / Accompagnement individuel",
    teacher_chk_resources: "Banque de ressources libre acc\u00e8s",
    teacher_chk_offline: "Mode \"Hors-ligne\" (T\u00e9l\u00e9chargement)",
    teacher_chk_whatsapp: "WhatsApp (Faible d\u00e9bit / Informalit\u00e9)",
    teacher_chk_peer: "Pair-\u00e0-pair local (T\u00e9moignages cr\u00e9dibles)",

    // Card 7: Scénario
    teacher_card_scenario: "Sc\u00e9nario / Journ\u00e9e Type",
    teacher_desc_scenario: "D\u00e9roul\u00e9 d\u2019une journ\u00e9e type et disponibilit\u00e9s.",
    teacher_lbl_scenario: "Racontez sa journ\u00e9e pour identifier les cr\u00e9neaux disponibles et les contraintes techniques.",
    teacher_ph_scenario: "Ex: Finit la classe \u00e0 13h \u00e0 cause de la chaleur. Pas de r\u00e9seau le soir...",

    // Footer
    teacher_footer: "D\u00e9velopp\u00e9 par Florent Michelot, inspir\u00e9 des travaux de Fran\u00e7ois Jourde & Jacques Dubois (2026) \u2022 CC BY-SA<br>Code original disponible sur <a href=\"https://github.com/jourde/artefacts\" target=\"_blank\" style=\"color: inherit;\">https://github.com/jourde/artefacts</a>",

    // Help modal
    teacher_help_title: "Guide d\u2019utilisation",
    teacher_help_body: "<p><strong>1. Objectif</strong><br>Ce canevas sert \u00e0 d\u00e9crire un profil type (persona) afin de concevoir des formations r\u00e9ellement adapt\u00e9es aux besoins, motivations, contraintes et contextes d\u2019exercice.</p><p><strong>2. Basculer les vues (en haut de page)</strong><br>Deux interrupteurs pilotent l\u2019affichage :<ul style=\"margin-top:5px;margin-bottom:10px;\"><li><strong>Basique / <span style=\"color:#0891b2;font-weight:bold;\">Avanc\u00e9</span> :</strong> active les options avanc\u00e9es pour sp\u00e9cifier des contextes particuliers (g\u00e9ographie, infrastructure, d\u00e9fis sp\u00e9cifiques, etc.).</li><li><strong>Suggestions :</strong> affiche (ou masque) les listes de cases \u00e0 cocher dans tous les blocs.</li></ul></p><p><strong>3. Renseigner le persona</strong><br><ul><li><strong>Texte libre :</strong> d\u00e9crivez les \u00e9l\u00e9ments qualitatifs.</li><li><strong>Suggestions :</strong> activez l\u2019interrupteur pour faire appara\u00eetre les options, puis cochez.</li></ul></p><p><strong>4. Import & Export</strong><br>Le bloc <strong>IMPORT & EXPORT</strong> regroupe les actions de partage et de sauvegarde.</p><p style=\"margin-top:12px;\"><strong>Note</strong><br>Cet outil est un <strong>prototype non officiel</strong>.</p>",
    teacher_help_advanced_toggle: "active les options avanc\u00e9es pour sp\u00e9cifier des contextes particuliers (g\u00e9ographie, infrastructure, d\u00e9fis sp\u00e9cifiques, etc.).",

    // About modal
    teacher_about_title: "\u00c0 propos",
    teacher_about_text: "Cet outil permet de mod\u00e9liser les besoins, motivations et contraintes des personnels d\u2019\u00e9ducation afin de concevoir des formations adapt\u00e9es.",
    teacher_about_prototype: "Ce document est un prototype non officiel, partag\u00e9 \u00e0 des fins de collecte de suggestions d\u2019am\u00e9lioration.",
    teacher_about_privacy: "<strong>Traitement local :</strong> toutes les donn\u00e9es restent sur votre navigateur, rien n\u2019est envoy\u00e9 en ligne.",
    teacher_about_credits: "D\u00e9velopp\u00e9 par Florent Michelot, inspir\u00e9 des travaux de F. Jourde & J. Dubois (2026) \u2022 CC BY-SA",

    // Suggestions modal
    teacher_suggest_title: "Proposer une am\u00e9lioration",
    teacher_suggest_intro: "Cet espace permet de proposer des am\u00e9liorations sur le contenu ou l\u2019interface. Les suggestions sont stock\u00e9es localement dans votre navigateur et peuvent \u00eatre export\u00e9es en fichier (JSON) afin de les partager.",
    teacher_suggest_lbl_category: "Cat\u00e9gorie",
    teacher_suggest_cat_content: "Contenu des blocs",
    teacher_suggest_cat_labels: "Libell\u00e9s / vocabulaire",
    teacher_suggest_cat_suggestions: "Suggestions propos\u00e9es",
    teacher_suggest_cat_ux: "Ergonomie / interface",
    teacher_suggest_cat_other: "Autre",
    teacher_suggest_lbl_priority: "Priorit\u00e9",
    teacher_suggest_prio_discuss: "\u00c0 discuter",
    teacher_suggest_prio_low: "Faible",
    teacher_suggest_prio_medium: "Moyenne",
    teacher_suggest_prio_high: "\u00c9lev\u00e9e",
    teacher_suggest_lbl_text: "Suggestion",
    teacher_suggest_ph_text: "D\u00e9crivez votre proposition de mani\u00e8re pr\u00e9cise (ex. libell\u00e9 \u00e0 modifier, option \u00e0 ajouter/supprimer, clarification \u00e0 apporter, etc.).",
    teacher_suggest_disclaimer: "Merci d\u2019\u00e9viter toute donn\u00e9e personnelle. Objectif : am\u00e9liorer le contenu et l\u2019ergonomie.",
    teacher_btn_add: "Ajouter",
    teacher_btn_export_suggestions: "Exporter les suggestions",
    teacher_suggest_share_title: "Partager le fichier",
    teacher_suggest_share_text: "Apr\u00e8s export, merci de partager le fichier <strong>JSON</strong> (par exemple en pi\u00e8ce jointe dans un e-mail ou via votre canal habituel) afin de contribuer \u00e0 l\u2019am\u00e9lioration du prototype.",

    // Dynamic JS strings
    teacher_suggestion_singular: "suggestion",
    teacher_suggestion_plural: "suggestions",
    teacher_no_suggestions: "Aucune suggestion enregistr\u00e9e pour le moment.",
    teacher_lbl_priority_display: "Priorit\u00e9",
    teacher_error_file_read: "Erreur lors de la lecture du fichier : ",
    teacher_error_pdf_loading: "La librairie PDF n\u2019est pas encore charg\u00e9e. Veuillez r\u00e9essayer dans un instant.",
    teacher_error_add_suggestion: "Merci de saisir une suggestion avant de l\u2019ajouter.",
    teacher_confirm_clear_suggestions: "Supprimer toutes les suggestions enregistr\u00e9es localement ?",
    teacher_error_no_suggestions: "Aucune suggestion \u00e0 exporter.",
    teacher_tool_name: "Canevas de personas \u2014 Personnel d\u2019\u00e9ducation (prototype)",

    // Markdown export
    teacher_md_profile_title: "Profil Persona",
    teacher_md_context_line: "Contexte : Personnel d\u2019\u00e9ducation",
    teacher_md_date: "Date",
    teacher_md_advanced_context: "Options avanc\u00e9es",
    teacher_md_field_label: "Champ",
    teacher_md_empty: "(vide)",

    // Full export
    teacher_md_full_title: "Canevas Persona Complet"
};

// ── DOM references ───────────────────────────────────────────────────────────
var toggle = document.getElementById('contextToggle');
var body = document.body;
var suggestionsToggle = document.getElementById('suggestionsToggle');
var infoModal = document.getElementById('infoModal');
var helpModal = document.getElementById('helpModal');
var suggestionsModal = document.getElementById('suggestionsModal');

// ── Suggestions storage ──────────────────────────────────────────────────────
var SUGGESTIONS_STORAGE_KEY = 'teacher_suggestions_v2';
var suggestions = [];

function loadSuggestionsFromStorage() {
    try {
        var raw = localStorage.getItem(SUGGESTIONS_STORAGE_KEY);
        suggestions = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(suggestions)) suggestions = [];
    } catch (e) {
        suggestions = [];
    }
}

function saveSuggestionsToStorage() {
    try {
        localStorage.setItem(SUGGESTIONS_STORAGE_KEY, JSON.stringify(suggestions));
    } catch (e) {}
}

// ── Toggle logic ─────────────────────────────────────────────────────────────
toggle.addEventListener('change', function () {
    if (this.checked) {
        body.classList.add('show-context');
    } else {
        body.classList.remove('show-context');
    }
});

suggestionsToggle.addEventListener('change', function () {
    if (this.checked) {
        body.classList.add('show-suggestions');
    } else {
        body.classList.remove('show-suggestions');
    }
});

// ── Save ─────────────────────────────────────────────────────────────────────
function saveData() {
    var data = {
        contextToggle: toggle.checked,
        suggestionsToggle: suggestionsToggle.checked,
        fields: {}
    };

    document.querySelectorAll('[id]').forEach(function (el) {
        if (el.id === 'contextToggle') return;
        if (el.id === 'suggestionsToggle') return;
        if (el.id === 'fileInput') return;
        if (el.id === 'langFileInput') return;
        if (el.id === 'langSelect') return;
        if (el.id === 'disciplineField') return;

        if (el.type === 'checkbox') {
            data.fields[el.id] = el.checked;
        } else if (el.value !== undefined) {
            data.fields[el.id] = el.value;
        }
    });

    var radioNames = new Set();
    document.querySelectorAll('input[type="radio"]').forEach(function (el) { radioNames.add(el.name); });
    radioNames.forEach(function (name) {
        var checked = document.querySelector('input[name="' + name + '"]:checked');
        if (checked) {
            data.fields['radio:' + name] = checked.value;
        }
    });

    var jsonStr = JSON.stringify(data, null, 2);
    var blob = new Blob([jsonStr], { type: "application/json" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement('a');
    a.href = url;
    a.download = "enseignant.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ── Load ─────────────────────────────────────────────────────────────────────
function loadData(input) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function (e) {
        try {
            var data = JSON.parse(e.target.result);
            restoreForm(data);
        } catch (err) {
            alert(i18nCore.t('teacher_error_file_read') + err);
        }
        input.value = '';
    };
    reader.readAsText(file);
}


// ── Legacy value mapping (France-specific → francophonie-wide) ────────────────
var legacyValueMap = {
    educationSector: {
        "Collège": "Secondaire (premier cycle / inférieur)",
        "Lycée général": "Secondaire (deuxième cycle / supérieur) — général",
        "Lycée professionnel": "Secondaire — technique et professionnel",
        "Grande école": "Haute école / École spécialisée",
        "BTS/IUT": "Collège / CÉGEP / Institut technologique",
        "GRETA/CFA": "Formation professionnelle / Apprentissage",
        "Spécialisé": "Éducation spécialisée / adaptation scolaire"
    },
    status: {
        "Titulaire": "Permanent",
        "Contractuel": "Contractuel",
        "Stagiaire": "Formation initiale",
        "Stagiaire (ESPE/INSPE)": "Formation initiale"
    }
};

function restoreForm(data) {
    toggle.checked = !!data.contextToggle;
    if (toggle.checked) body.classList.add('show-context');
    else body.classList.remove('show-context');

    suggestionsToggle.checked = !!data.suggestionsToggle;
    if (suggestionsToggle.checked) body.classList.add('show-suggestions');
    else body.classList.remove('show-suggestions');

    for (var key in data.fields) {
        if (!data.fields.hasOwnProperty(key)) continue;
        var value = data.fields[key];
        if (key.indexOf('radio:') === 0) {
            var name = key.split(':')[1];
            var radio = document.querySelector('input[name="' + name + '"][value="' + value + '"]');
            if (radio) radio.checked = true;
        } else {
            var el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = value;
                else {
                    // Map legacy values if needed
                    if (legacyValueMap && legacyValueMap[el.id] && legacyValueMap[el.id][value]) {
                        el.value = legacyValueMap[el.id][value];
                    } else {
                        el.value = value;
                    }
                }
            }
        }
    }

    // Update discipline field visibility after restoring education sector
    var sectorEl = document.getElementById('educationSector');
    if (sectorEl) handleSectorChange(sectorEl.value);
}

// ── PDF Export ────────────────────────────────────────────────────────────────
function exportPDF() {
    var nameValue = document.getElementById('name').value;
    var safeName = nameValue ? nameValue.replace(/[^a-z0-9]/gi, '_') : 'persona';

    var element = document.body;
    var opt = {
        margin: 10,
        filename: 'Canevas_' + safeName + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    if (typeof html2pdf !== 'undefined') {
        html2pdf().set(opt).from(element).save();
    } else {
        alert(i18nCore.t('teacher_error_pdf_loading'));
    }
}

// ── Markdown Export ──────────────────────────────────────────────────────────
function exportMarkdown() {
    var name = document.getElementById('name').value || 'Persona';
    var md = '# ' + i18nCore.t('teacher_md_profile_title') + ' : ' + name + '\n';
    md += '> ' + i18nCore.t('teacher_md_context_line') + '\n';
    md += '> ' + i18nCore.t('teacher_md_date') + ' : ' + new Date().toLocaleDateString() + '\n\n';

    var isAdvanced = document.getElementById('contextToggle').checked;

    var processElement = function (el) {
        var text = '';

        if (el.classList.contains('form-group')) {
            var labelEl = el.querySelector('label');
            var label = labelEl ? labelEl.textContent.replace(':', '').trim() : i18nCore.t('teacher_md_field_label');

            var simpleInput = el.querySelector('input[type="text"], select, textarea');
            if (simpleInput) {
                var val = simpleInput.value.trim();
                if (val) {
                    text += '- **' + label + '** : ' + val + '\n';
                }
            }

            var inputs = el.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            if (inputs.length > 0) {
                if (inputs[0].type === 'radio') {
                    var checked = el.querySelector('input:checked');
                    if (checked) {
                        text += '- **' + label + '** : ' + checked.parentElement.textContent.trim() + '\n';
                    }
                } else {
                    var checkedBoxes = el.querySelectorAll('input:checked');
                    if (checkedBoxes.length > 0) {
                        text += '- **' + label + '** :\n';
                        checkedBoxes.forEach(function (c) {
                            text += '  - ' + c.parentElement.textContent.trim() + '\n';
                        });
                    }
                }
            }
        } else if (el.classList.contains('checkbox-group')) {
            var checkedItems = el.querySelectorAll('input:checked');
            checkedItems.forEach(function (c) {
                text += '- ' + c.parentElement.textContent.trim() + '\n';
            });
        }
        return text;
    };

    document.querySelectorAll('.card').forEach(function (card) {
        var title = "";
        var h2 = card.querySelector('h2');
        if (h2) {
            title = Array.from(h2.childNodes)
                .filter(function (n) { return n.nodeType === Node.TEXT_NODE || (n.nodeType === Node.ELEMENT_NODE && n.hasAttribute('data-i18n')); })
                .map(function (n) { return n.textContent.trim(); })
                .join(' ').trim();
        }

        var sectionContent = '';

        Array.from(card.children).forEach(function (child) {
            if (child.tagName === 'H2') return;
            if (child.tagName === 'BUTTON') return;
            if (child.classList.contains('card-desc')) return;

            if (child.classList.contains('advanced-context')) {
                if (isAdvanced) {
                    var contextContent = '';
                    Array.from(child.children).forEach(function (ctxChild) {
                        contextContent += processElement(ctxChild);
                    });
                    if (contextContent) {
                        sectionContent += '\n> **' + i18nCore.t('teacher_md_advanced_context') + '**\n' + contextContent;
                    }
                }
            } else if (child.classList.contains('suggestions-panel')) {
                Array.from(child.children).forEach(function (innerChild) {
                    sectionContent += processElement(innerChild);
                });
            } else {
                sectionContent += processElement(child);
            }
        });

        if (sectionContent.trim()) {
            md += '## ' + title + '\n' + sectionContent + '\n';
        }
    });

    var blob = new Blob([md], { type: 'text/markdown' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Persona_' + name.replace(/\s+/g, '_') + '.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ── Full Markdown Export ─────────────────────────────────────────────────────
function exportFullMarkdown() {
    var name = document.getElementById('name').value || 'Persona';
    var md = '# ' + i18nCore.t('teacher_md_full_title') + ' : ' + name + '\n';
    md += '> ' + i18nCore.t('teacher_md_context_line') + '\n';
    md += '> ' + i18nCore.t('teacher_md_date') + ' : ' + new Date().toLocaleDateString() + '\n\n';

    var processElementFull = function (el) {
        var text = '';

        if (el.classList.contains('form-group')) {
            var labelEl = el.querySelector('label');
            var label = labelEl ? labelEl.textContent.replace(':', '').trim() : i18nCore.t('teacher_md_field_label');

            var simpleInput = el.querySelector('input[type="text"], select, textarea');
            if (simpleInput) {
                if (simpleInput.tagName === 'SELECT') {
                    text += '- **' + label + '** :\n';
                    Array.from(simpleInput.options).forEach(function (opt) {
                        if (opt.value) {
                            var isSelected = opt.selected;
                            text += '  - [' + (isSelected ? 'x' : ' ') + '] ' + opt.text + '\n';
                        }
                    });
                } else {
                    var val = simpleInput.value.trim();
                    text += '- **' + label + '** : ' + (val || i18nCore.t('teacher_md_empty')) + '\n';
                }
            }

            var inputs = el.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            if (inputs.length > 0) {
                text += '- **' + label + '** :\n';
                inputs.forEach(function (input) {
                    var isChecked = input.checked;
                    var itemLabel = input.parentElement.textContent.trim();
                    text += '  - [' + (isChecked ? 'x' : ' ') + '] ' + itemLabel + '\n';
                });
            }
        } else if (el.classList.contains('checkbox-group')) {
            var allInputs = el.querySelectorAll('input[type="checkbox"]');
            allInputs.forEach(function (input) {
                var isChecked = input.checked;
                var itemLabel = input.parentElement.textContent.trim();
                text += '- [' + (isChecked ? 'x' : ' ') + '] ' + itemLabel + '\n';
            });
        }
        return text;
    };

    document.querySelectorAll('.card').forEach(function (card) {
        var title = "";
        var h2 = card.querySelector('h2');
        if (h2) {
            title = Array.from(h2.childNodes)
                .filter(function (n) { return n.nodeType === Node.TEXT_NODE || (n.nodeType === Node.ELEMENT_NODE && n.hasAttribute('data-i18n')); })
                .map(function (n) { return n.textContent.trim(); })
                .join(' ').trim();
        }

        var sectionContent = '';

        Array.from(card.children).forEach(function (child) {
            if (child.tagName === 'H2') return;
            if (child.tagName === 'BUTTON') return;
            if (child.classList.contains('card-desc')) return;

            if (child.classList.contains('advanced-context')) {
                var contextContent = '';
                Array.from(child.children).forEach(function (ctxChild) {
                    contextContent += processElementFull(ctxChild);
                });
                if (contextContent) {
                    sectionContent += '\n> **' + i18nCore.t('teacher_md_advanced_context') + '**\n' + contextContent;
                }
            } else if (child.classList.contains('suggestions-panel')) {
                Array.from(child.children).forEach(function (innerChild) {
                    sectionContent += processElementFull(innerChild);
                });
            } else {
                sectionContent += processElementFull(child);
            }
        });

        if (sectionContent.trim()) {
            md += '## ' + title + '\n' + sectionContent + '\n';
        }
    });

    var blob = new Blob([md], { type: 'text/markdown' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Persona_Complet_' + name.replace(/\s+/g, '_') + '.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ── Reset ────────────────────────────────────────────────────────────────────
function resetForm() {
    document.getElementById('personaForm').reset();
    toggle.checked = false;
    body.classList.remove('show-context');
    suggestionsToggle.checked = false;
    body.classList.remove('show-suggestions');
    handleSectorChange('');
}

// ── Education Sector ─────────────────────────────────────────────────────────
function handleSectorChange(sector) {
    var disciplineField = document.getElementById('disciplineField');
    var showDiscipline = [
        'Collège', 'Lycée général', 'Lycée professionnel',
        'Université', 'Grande école', 'BTS/IUT'
    ].indexOf(sector) !== -1;
    if (disciplineField) {
        disciplineField.style.display = showDiscipline ? '' : 'none';
    }
}

// ── Suggestions ──────────────────────────────────────────────────────────────
function pluraliseSuggestion(n) {
    return n === 1 ? i18nCore.t('teacher_suggestion_singular') : i18nCore.t('teacher_suggestion_plural');
}

function formatDateTimeISO(dt) {
    var pad = function (x) { return String(x).padStart(2, '0'); };
    return dt.getFullYear()
        + '-' + pad(dt.getMonth() + 1)
        + '-' + pad(dt.getDate())
        + ' ' + pad(dt.getHours())
        + ':' + pad(dt.getMinutes());
}

function renderSuggestions() {
    var countEl = document.getElementById('suggestionsCount');
    var listEl = document.getElementById('suggestionsList');
    if (!countEl || !listEl) return;

    var n = suggestions.length;
    countEl.textContent = n + ' ' + pluraliseSuggestion(n);

    if (n === 0) {
        listEl.innerHTML = '<div style="color:#64748b; font-size:0.92rem; margin-top: 8px;">' + i18nCore.t('teacher_no_suggestions') + '</div>';
        return;
    }

    var prioLabel = i18nCore.t('teacher_lbl_priority_display');
    var items = suggestions
        .slice()
        .sort(function (a, b) { return (b.created_at || 0) - (a.created_at || 0); })
        .map(function (s) {
            var created = s.created_at ? formatDateTimeISO(new Date(s.created_at)) : '';
            var cat = s.category || '\u2014';
            var prio = s.priority || '\u2014';
            var text = (s.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return '<div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#ffffff; margin-top:10px;">'
                + '<div style="display:flex; gap:10px; align-items: baseline; flex-wrap: wrap;">'
                +   '<span style="font-weight:700; color:#0f172a;">' + cat + '</span>'
                +   '<span style="color:#64748b;">\u2022</span>'
                +   '<span style="font-weight:600; color:#334155;">' + prioLabel + ' : ' + prio + '</span>'
                +   (created ? '<span style="margin-left:auto; color:#64748b; font-size:0.85rem;">' + created + '</span>' : '<span style="margin-left:auto;"></span>')
                + '</div>'
                + '<div style="margin-top:8px; white-space:pre-wrap; color:#0f172a;">' + text + '</div>'
                + '<div style="margin-top:10px; display:flex; justify-content:flex-end;">'
                +   '<button class="btn btn-reset" onclick="removeSuggestion(\'' + s.id + '\')" data-tooltip="' + i18nCore.t('teacher_tip_clear_suggestions') + '">'
                +     '<span class="material-icons">delete</span>'
                +   '</button>'
                + '</div></div>';
        })
        .join('');

    listEl.innerHTML = items;
}

function openSuggestionsModal() {
    loadSuggestionsFromStorage();
    renderSuggestions();
    suggestionsModal.style.display = "block";
}

function closeSuggestionsModal() {
    suggestionsModal.style.display = "none";
}

function addSuggestion() {
    var catEl = document.getElementById('suggestionCategory');
    var prioEl = document.getElementById('suggestionPriority');
    var textEl = document.getElementById('suggestionText');

    if (!textEl) return;

    var text = (textEl.value || '').trim();
    if (!text) {
        alert(i18nCore.t('teacher_error_add_suggestion'));
        return;
    }

    var suggestion = {
        id: 'sug_' + Math.random().toString(36).slice(2) + '_' + Date.now(),
        created_at: Date.now(),
        category: catEl ? catEl.value : i18nCore.t('teacher_suggest_cat_other'),
        priority: prioEl ? prioEl.value : i18nCore.t('teacher_suggest_prio_discuss'),
        text: text
    };

    loadSuggestionsFromStorage();
    suggestions.push(suggestion);
    saveSuggestionsToStorage();

    textEl.value = '';
    renderSuggestions();
}

function removeSuggestion(id) {
    loadSuggestionsFromStorage();
    suggestions = suggestions.filter(function (s) { return s.id !== id; });
    saveSuggestionsToStorage();
    renderSuggestions();
}

function clearSuggestions() {
    var ok = confirm(i18nCore.t('teacher_confirm_clear_suggestions'));
    if (!ok) return;
    suggestions = [];
    saveSuggestionsToStorage();
    renderSuggestions();
}

function exportSuggestions() {
    loadSuggestionsFromStorage();

    if (!suggestions || suggestions.length === 0) {
        alert(i18nCore.t('teacher_error_no_suggestions'));
        return;
    }

    var payload = {
        tool: i18nCore.t('teacher_tool_name'),
        exported_at: new Date().toISOString(),
        suggestions: suggestions
    };

    var blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
    var url = URL.createObjectURL(blob);

    var dt = new Date();
    var pad = function (x) { return String(x).padStart(2, '0'); };
    var filename = 'suggestions-enseignant-' + dt.getFullYear() + pad(dt.getMonth() + 1) + pad(dt.getDate()) + '-' + pad(dt.getHours()) + pad(dt.getMinutes()) + pad(dt.getSeconds()) + '.json';

    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ── Modals ───────────────────────────────────────────────────────────────────
function openInfoModal() { infoModal.style.display = "block"; }
function closeInfoModal() { infoModal.style.display = "none"; }

function openHelpModal() { helpModal.style.display = "block"; }
function closeHelpModal() { helpModal.style.display = "none"; }

window.onclick = function (event) {
    if (event.target == infoModal) infoModal.style.display = "none";
    if (event.target == helpModal) helpModal.style.display = "none";
    if (event.target == suggestionsModal) suggestionsModal.style.display = "none";
};

// ── i18n Functions ───────────────────────────────────────────────────────────
function switchLang(code) {
    if (code && i18nCore.translations[code]) {
        i18nCore.setLang(code);
    }
}

function loadLangPack(event) {
    i18nCore.loadLanguagePackFromFile(event, function (code) {
        var sel = document.getElementById('langSelect');
        if (sel && !sel.querySelector('option[value="' + code + '"]')) {
            var opt = document.createElement('option');
            opt.value = code;
            opt.textContent = code;
            sel.appendChild(opt);
        }
        i18nCore.setLang(code);
    });
}

function syncLangSelector() {
    var sel = document.getElementById('langSelect');
    if (sel) sel.value = i18nCore.currentLang;
}

// ── Initialization ───────────────────────────────────────────────────────────
i18nCore.init({
    defaultLang: 'fr',
    translations: { 'fr': translations_fr },
    persist: true
});

// Auto-load English Canadian pack
i18nCore.loadLanguagePack('i18n/en-CA.json').then(function (code) {
    try {
        var stored = localStorage.getItem('ld_ui_lang');
        if (stored && stored !== 'fr' && i18nCore.translations[stored]) {
            i18nCore.setLang(stored);
        }
    } catch (_) {}
    syncLangSelector();
}).catch(function (err) {
    console.warn('[i18n] Could not load en-CA pack:', err);
});

document.title = i18nCore.t('teacher_page_title');

// Initialize discipline field visibility
var sectorInit = document.getElementById('educationSector');
if (sectorInit) handleSectorChange(sectorInit.value);

// Re-render dynamic content when language changes
document.addEventListener('i18n:langchange', function () {
    document.title = i18nCore.t('teacher_page_title');
    syncLangSelector();
});
